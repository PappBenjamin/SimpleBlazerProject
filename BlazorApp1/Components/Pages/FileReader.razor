@page "/filereader"
@using BlazorApp1.Services
@inject FileReaderService FileReaderService
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Components.Forms

<!-- Component for reading and displaying file content. -->
<PageTitle>File Reader</PageTitle>

<!-- Container for the file input control -->
<div class="file-input-container">
    <InputFile id="file-input" OnChange="HandleFileSelected" class="file-input" /> <!-- File input element that triggers HandleFileSelected on change -->
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="error-message">@errorMessage</p>
}

<!-- Renders the table and search bar only if file content is available -->
@if (fileContent != null)
{
    <!-- Container for the search bar -->
    <div class="search-bar-container">
        <InputText @bind-Value="searchTerm" placeholder="Search by name..." class="form-control" /> <!-- Search input field, bound to searchTerm -->
    </div>

    <!-- Container for the table displaying file content -->
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th> <!-- Header for the name column -->
                    <th>Details</th> <!-- Header for the details column -->
                </tr>
            </thead>
            <tbody>
            
            <!-- Iterates through the filtered file content to display rows -->
            @foreach (var row in FilteredContent)
            {
                <tr>
                    <td>@row.First()</td> <!-- Displays the first element of the row as the name -->
                    <td>
                        <!-- Button to toggle visibility of row details -->
                        <button @onclick="(() => ToggleDetails(row))" class="btn btn-info btn-sm">
                            @(expandedRows.Contains(row) ? "Hide Details" : "Show Details") <!-- Button text changes based on expansion state -->
                        </button>
                    </td>
                </tr>
                <!-- Displays additional details if the row is expanded -->
                @if (expandedRows.Contains(row))
                {
                    <tr>
                        <td colspan="2">
                            <!-- Container for the detailed information of an expanded row -->
                            <div class="details-container">
                                <!-- Loops through remaining cells to display details with their respective headers -->
                                @for (int i = 0; i < row.Length - 1; i++)
                                {
                                    <p>@fileContent.First()[i + 1]: @row.Skip(1).ElementAt(i)</p>
                                    <!-- Displays header and corresponding cell value -->
                                }
                            </div>
                        </td>
                    </tr>
                }
            }
            </tbody>
        </table>
    </div>
}
else
{
    <!-- Message displayed when no file is loaded -->
    <p>
        <em>Select a file to read its content.</em>
    </p>
}

@code {
    private List<string[]> fileContent; // Stores the content read from the file
    private string errorMessage; // Stores any error messages during file processing
    private string searchTerm = string.Empty; // Binds to the search input field
    private HashSet<string[]> expandedRows = new HashSet<string[]>(); // Tracks which rows have their details expanded

    // Computed property to get filtered file content based on searchTerm
    private IEnumerable<string[]> FilteredContent
    {
        get
        {
            if (fileContent == null || !fileContent.Any()) return Enumerable.Empty<string[]>();

            var dataRows = fileContent.Skip(1); // Skips the header row

            if (string.IsNullOrWhiteSpace(searchTerm))
            {
                return dataRows; // Returns all data rows if search term is empty
            }

            // Filters data rows where the first column (name) contains the search term
            return dataRows.Where(row => row.Any() && row.First().Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }
    }

    // Toggles the expansion state of a row
    private void ToggleDetails(string[] row)
    {
        if (expandedRows.Contains(row))
        {
            expandedRows.Remove(row); // Hides details if already expanded
        }
        else
        {
            expandedRows.Add(row); // Shows details if not expanded
        }
    }

    // Event handler for when a file is selected via InputFile
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        errorMessage = null; // Clears any previous error messages

        if (file != null)
        {
            Console.WriteLine($"File selected: {file.Name}");
            try
            {
                // Opens and reads the selected file stream (max 10 MB)
                using (var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 10))
                {
                    fileContent = await FileReaderService.ReadFile(stream, file.Name); // Reads file content using the injected service
                    expandedRows.Clear(); // Clears expanded rows when a new file is selected
                    Console.WriteLine($"Read {fileContent.Count} rows from {file.Name}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error reading file: {ex.Message}"); // Logs error to console
                errorMessage = $"Error reading file: {ex.Message}"; // Sets user-friendly error message
                fileContent = null; // Clears displayed content on error
                expandedRows.Clear(); // Clears expanded rows on error
            }
        }
    }
}
