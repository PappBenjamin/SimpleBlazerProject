@page "/filereader"
@using BlazorApp1.Services
@inject FileReaderService FileReaderService
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>File Reader</PageTitle>

<div class="file-input-container">
    <InputFile id="file-input" OnChange="HandleFileSelected" class="file-input" />
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="error-message">@errorMessage</p>
}

@if (fileContent != null)
{
    <div class="search-bar-container">
        <InputText @bind-Value="searchTerm" placeholder="Search by name..." class="form-control" />
    </div>

    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in FilteredContent)
                {
                    <tr>
                        <td>@row.First()</td>
                        <td>
                            <button @onclick="(() => ToggleDetails(row))" class="btn btn-info btn-sm">
                                @(expandedRows.Contains(row) ? "Hide Details" : "Show Details")
                            </button>
                        </td>
                    </tr>
                    @if (expandedRows.Contains(row))
                    {
                        <tr>
                            <td colspan="2">
                                <div class="details-container">
                                    @for (int i = 0; i < row.Length - 1; i++)
                                    {
                                        <p>@fileContent.First()[i + 1]: @row.Skip(1).ElementAt(i)</p>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p>
        <em>Select a file to read its content.</em>
    </p>
}

@code {
    private List<string[]> fileContent;
    private string errorMessage;
    private string searchTerm = string.Empty;
    private HashSet<string[]> expandedRows = new HashSet<string[]>();

    private IEnumerable<string[]> FilteredContent
    {
        get
        {
            if (fileContent == null || !fileContent.Any()) return Enumerable.Empty<string[]>();

            var dataRows = fileContent.Skip(1);

            if (string.IsNullOrWhiteSpace(searchTerm))
            {
                return dataRows;
            }

            return dataRows.Where(row => row.Any() && row.First().Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }
    }

    private void ToggleDetails(string[] row)
    {
        if (expandedRows.Contains(row))
        {
            expandedRows.Remove(row);
        }
        else
        {
            expandedRows.Add(row);
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        errorMessage = null; // Clear previous error messages

        if (file != null)
        {
            Console.WriteLine($"File selected: {file.Name}");
            try
            {
                using (var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 10)) // 10 MB max file size
                {
                    fileContent = await FileReaderService.ReadFile(stream, file.Name);
                    expandedRows.Clear(); // Clear expanded rows on new file selection
                    Console.WriteLine($"Read {fileContent.Count} rows from {file.Name}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error reading file: {ex.Message}");
                errorMessage = $"Error reading file: {ex.Message}";
                fileContent = null; // Clear the displayed content
                expandedRows.Clear(); // Clear expanded rows on error
            }
        }
    }
}
