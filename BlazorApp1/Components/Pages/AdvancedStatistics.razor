@page "/advanced-statistics"
@using BlazorApp1.Services
@using System.Text.Json
@inject DataManagementService DataManagementService
@rendermode InteractiveServer

<h3>Advanced Data Statistics</h3>

@if (columnNames == null || !columnNames.Any())
{
    <p>‚ùå No data loaded. Please upload a JSON file first.</p>
}
else
{
    <div class="alert alert-info">
        <strong>‚úì Data Loaded!</strong> Total Records: @totalRecords | Total Columns: @columnNames.Count
    </div>

    <hr class="my-4" />
    
    <h4>üìä Choose Analysis Type:</h4>
    <div class="btn-group mb-4" role="group">
        <button type="button" class="btn btn-primary" @onclick='() => SetAnalysisType("numerical")'>Numerical Statistics</button>
        <button type="button" class="btn btn-primary" @onclick='() => SetAnalysisType("groupby")'>Group By Analysis</button>
        <button type="button" class="btn btn-primary" @onclick='() => SetAnalysisType("topvalues")'>Top Values</button>
        <button type="button" class="btn btn-secondary" @onclick='() => SetAnalysisType("")'>Clear</button>
    </div>

    @if (selectedAnalysisType == "numerical")
    {
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5>üìà Numerical Column Statistics</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Select a Column:</strong></label>
                    <div>
                        @foreach (var col in columnNames)
                        {
                            <button class="btn btn-sm btn-outline-info me-2 mb-2" @onclick='() => SelectNumericalColumn(col)'>
                                @col
                            </button>
                        }
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(selectedNumericalColumn))
                {
                    <div class="alert alert-secondary">
                        <h5>Statistics for: <strong>@selectedNumericalColumn</strong></h5>
                    </div>
                    
                    @if (numericalStats != null && numericalStats.Any())
                    {
                        <table class="table table-bordered table-sm">
                            <tbody>
                                <tr class="table-light"><td><strong>Count</strong></td><td>@numericalStats["Count"]</td></tr>
                                <tr class="table-light"><td><strong>Sum</strong></td><td>@(numericalStats["Sum"]?.ToString("F2") ?? "N/A")</td></tr>
                                <tr class="table-light"><td><strong>Average</strong></td><td>@(numericalStats["Average"]?.ToString("F2") ?? "N/A")</td></tr>
                                <tr class="table-light"><td><strong>Min</strong></td><td>@(numericalStats["Min"]?.ToString("F2") ?? "N/A")</td></tr>
                                <tr class="table-light"><td><strong>Max</strong></td><td>@(numericalStats["Max"]?.ToString("F2") ?? "N/A")</td></tr>
                                <tr class="table-light"><td><strong>Median</strong></td><td>@(numericalStats["Median"]?.ToString("F2") ?? "N/A")</td></tr>
                                <tr class="table-light"><td><strong>Std Dev</strong></td><td>@(numericalStats["StdDev"]?.ToString("F2") ?? "N/A")</td></tr>
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="alert alert-warning">‚ö†Ô∏è No numerical data found in this column</div>
                    }
                }
            </div>
        </div>
    }
    else if (selectedAnalysisType == "groupby")
    {
        <div class="card mb-4">
            <div class="card-header bg-warning text-white">
                <h5>üè∑Ô∏è Group By Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>Group By Column:</strong></label>
                        <div>
                            @foreach (var col in columnNames)
                            {
                                <button class="btn btn-sm btn-outline-warning me-2 mb-2" @onclick='() => SetGroupByColumn(col)'>
                                    @col
                                </button>
                            }
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>Aggregate Column (Numeric):</strong></label>
                        <div>
                            @foreach (var col in columnNames)
                            {
                                <button class="btn btn-sm btn-outline-warning me-2 mb-2" @onclick='() => SetAggregateColumn(col)'>
                                    @col
                                </button>
                            }
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(selectedGroupByColumn) && !string.IsNullOrEmpty(selectedAggregateColumn))
                {
                    <div class="alert alert-secondary">
                        <p>Group by: <strong>@selectedGroupByColumn</strong> | Aggregate: <strong>@selectedAggregateColumn</strong></p>
                    </div>

                    @if (groupByResults != null && groupByResults.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>@selectedGroupByColumn</th>
                                        <th>Count</th>
                                        <th>Average</th>
                                        <th>Min</th>
                                        <th>Max</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var group in groupByResults.OrderByDescending(g => (double?)g["Average"]))
                                    {
                                        <tr>
                                            <td>@group["GroupValue"]</td>
                                            <td>@group["Count"]</td>
                                            <td>@(((double?)group["Average"])?.ToString("F2") ?? "N/A")</td>
                                            <td>@(((double?)group["Min"])?.ToString("F2") ?? "N/A")</td>
                                            <td>@(((double?)group["Max"])?.ToString("F2") ?? "N/A")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">‚ö†Ô∏è No data to display. Make sure both columns contain numeric values.</div>
                    }
                }
            </div>
        </div>
    }
    else if (selectedAnalysisType == "topvalues")
    {
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5>üèÜ Top Values Analysis</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Select Column to Rank:</strong></label>
                    <div>
                        @foreach (var col in columnNames)
                        {
                            <button class="btn btn-sm btn-outline-danger me-2 mb-2" @onclick='() => SelectTopValueColumn(col)'>
                                @col
                            </button>
                        }
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(selectedTopValueColumn))
                {
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Show Top N:</strong></label>
                            <input type="number" class="form-control" @bind="topValuesCount" @oninput='(ChangeEventArgs e) => UpdateTopValues()' min="1" max="100" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Sort Order:</strong></label>
                            <select class="form-select" @onchange='(ChangeEventArgs e) => UpdateTopValueSort(e)'>
                                <option value="desc">Highest First (Descending)</option>
                                <option value="asc">Lowest First (Ascending)</option>
                            </select>
                        </div>
                    </div>

                    @if (topValuesResults != null && topValuesResults.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Value</th>
                                        <th>Frequency</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int rank = 1;
                                        foreach (var item in topValuesResults)
                                        {
                                            <tr>
                                                <td>@rank</td>
                                                <td>@item["Value"]</td>
                                                <td>@item["Count"]</td>
                                            </tr>
                                            rank++;
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">‚ö†Ô∏è No data to display for this column.</div>
                    }
                }
            </div>
        </div>
    }
}

@code {
    private List<string> columnNames = new();
    private int totalRecords = 0;
    private string selectedAnalysisType = string.Empty;
    
    // Numerical Statistics
    private string selectedNumericalColumn = string.Empty;
    private Dictionary<string, double?>? numericalStats;

    // Group By Analysis
    private string selectedGroupByColumn = string.Empty;
    private string selectedAggregateColumn = string.Empty;
    private List<Dictionary<string, object>>? groupByResults;

    // Top Values Analysis
    private string selectedTopValueColumn = string.Empty;
    private int topValuesCount = 10;
    private string topValuesSortOrder = "desc";
    private List<Dictionary<string, object>>? topValuesResults;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(100);
        columnNames = DataManagementService.GetColumnNames();
        totalRecords = DataManagementService.GetItemCount();
        Console.WriteLine($"‚úì Initialized: {totalRecords} records, {columnNames.Count} columns");
    }

    private void SetAnalysisType(string type)
    {
        selectedAnalysisType = type;
        ResetAnalysis();
        Console.WriteLine($"Analysis type set to: {type}");
    }

    private void SelectNumericalColumn(string column)
    {
        selectedNumericalColumn = column;
        CalculateNumericalStatistics();
        StateHasChanged();
        Console.WriteLine($"Numerical column: {column}");
    }

    private void SetGroupByColumn(string column)
    {
        selectedGroupByColumn = column;
        CalculateGroupByStatistics();
        StateHasChanged();
        Console.WriteLine($"GroupBy column: {column}");
    }

    private void SetAggregateColumn(string column)
    {
        selectedAggregateColumn = column;
        CalculateGroupByStatistics();
        StateHasChanged();
        Console.WriteLine($"Aggregate column: {column}");
    }

    private void SelectTopValueColumn(string column)
    {
        selectedTopValueColumn = column;
        CalculateTopValues();
        StateHasChanged();
        Console.WriteLine($"Top values column: {column}");
    }

    private void UpdateTopValueSort(ChangeEventArgs e)
    {
        topValuesSortOrder = e.Value?.ToString() ?? "desc";
        CalculateTopValues();
        StateHasChanged();
    }

    private void UpdateTopValues()
    {
        CalculateTopValues();
        StateHasChanged();
    }

    private void ResetAnalysis()
    {
        numericalStats = null;
        groupByResults = null;
        topValuesResults = null;
        selectedNumericalColumn = string.Empty;
        selectedGroupByColumn = string.Empty;
        selectedAggregateColumn = string.Empty;
        selectedTopValueColumn = string.Empty;
    }

    private void CalculateNumericalStatistics()
    {
        numericalStats = new Dictionary<string, double?>();
        var numericalValues = new List<double>();
        var allData = DataManagementService.GetAllData();

        foreach (var item in allData)
        {
            if (item.TryGetValue(selectedNumericalColumn, out object? value))
            {
                if (TryGetDoubleValue(value, out double numVal))
                {
                    numericalValues.Add(numVal);
                }
            }
        }

        if (numericalValues.Any())
        {
            numericalStats["Count"] = numericalValues.Count;
            numericalStats["Sum"] = numericalValues.Sum();
            numericalStats["Average"] = numericalValues.Average();
            numericalStats["Min"] = numericalValues.Min();
            numericalStats["Max"] = numericalValues.Max();
            numericalStats["Median"] = GetMedian(numericalValues);
            numericalStats["StdDev"] = CalculateStandardDeviation(numericalValues);
            Console.WriteLine($"‚úì Stats: {numericalValues.Count} values, Avg={numericalStats["Average"]}");
        }
    }

    private void CalculateGroupByStatistics()
    {
        if (string.IsNullOrEmpty(selectedGroupByColumn) || string.IsNullOrEmpty(selectedAggregateColumn))
        {
            groupByResults = null;
            return;
        }

        var allData = DataManagementService.GetAllData();
        var groupedData = new Dictionary<string, List<double>>();

        foreach (var item in allData)
        {
            if (item.TryGetValue(selectedGroupByColumn, out object? groupValue) &&
                item.TryGetValue(selectedAggregateColumn, out object? aggValue))
            {
                string groupKey = groupValue?.ToString() ?? "Unknown";
                
                if (TryGetDoubleValue(aggValue, out double numVal))
                {
                    if (!groupedData.ContainsKey(groupKey))
                        groupedData[groupKey] = new List<double>();
                    groupedData[groupKey].Add(numVal);
                }
            }
        }

        groupByResults = new();
        foreach (var group in groupedData)
        {
            if (group.Value.Any())
            {
                groupByResults.Add(new Dictionary<string, object>
                {
                    { "GroupValue", group.Key },
                    { "Count", group.Value.Count },
                    { "Average", group.Value.Average() },
                    { "Min", group.Value.Min() },
                    { "Max", group.Value.Max() }
                });
            }
        }
        Console.WriteLine($"‚úì GroupBy: {groupByResults.Count} groups");
    }

    private void CalculateTopValues()
    {
        if (string.IsNullOrEmpty(selectedTopValueColumn))
        {
            topValuesResults = null;
            return;
        }

        var allData = DataManagementService.GetAllData();
        var valueCounts = new Dictionary<string, int>();

        foreach (var item in allData)
        {
            if (item.TryGetValue(selectedTopValueColumn, out object? value))
            {
                string valueKey = value?.ToString() ?? "Unknown";
                valueCounts[valueKey] = valueCounts.ContainsKey(valueKey) ? valueCounts[valueKey] + 1 : 1;
            }
        }

        var sorted = topValuesSortOrder == "desc"
            ? valueCounts.OrderByDescending(x => x.Value).Take(topValuesCount)
            : valueCounts.OrderBy(x => x.Value).Take(topValuesCount);

        topValuesResults = sorted.Select(x => new Dictionary<string, object>
        {
            { "Value", x.Key },
            { "Count", x.Value }
        }).ToList();
        
        Console.WriteLine($"‚úì TopValues: {topValuesResults.Count} items");
    }

    private bool TryGetDoubleValue(object? value, out double result)
    {
        result = 0;

        if (value is JsonElement jsonElement)
        {
            if (jsonElement.ValueKind == JsonValueKind.Number && jsonElement.TryGetDouble(out double numVal))
            {
                result = numVal;
                return true;
            }
            if (double.TryParse(jsonElement.ToString(), out numVal))
            {
                result = numVal;
                return true;
            }
        }
        else if (value is double d)
        {
            result = d;
            return true;
        }
        else if (value != null && double.TryParse(value.ToString(), out double numVal))
        {
            result = numVal;
            return true;
        }

        return false;
    }

    private double GetMedian(List<double> values)
    {
        var sorted = values.OrderBy(x => x).ToList();
        int count = sorted.Count;
        return count % 2 == 0 
            ? (sorted[count / 2 - 1] + sorted[count / 2]) / 2 
            : sorted[count / 2];
    }

    private double CalculateStandardDeviation(List<double> values)
    {
        if (values.Count < 2) return 0;
        double average = values.Average();
        double sumOfSquares = values.Sum(x => Math.Pow(x - average, 2));
        return Math.Sqrt(sumOfSquares / (values.Count - 1));
    }
}
